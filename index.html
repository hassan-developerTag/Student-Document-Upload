<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Your Photo ID</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 500px;
        margin: 40px auto;
        text-align: center;
      }
      .box {
        border: 2px dashed #2563eb;
        padding: 20px;
        border-radius: 10px;
      }
      button {
        margin-top: 15px;
        padding: 10px 18px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:disabled {
        background: #aaa;
      }
    </style>
  </head>
  <body>
    <h1>Upload Your Photo ID</h1>
    <p>Please upload a passport, driver’s licence, or proof of address.</p>

    <div class="box">
      <input type="file" id="fileInput" accept="image/*,.pdf" />
      <br />
      <button id="uploadBtn">Upload</button>
      <p id="status"></p>
    </div>

    <script>
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");
      const statusEl = document.getElementById("status");

      uploadBtn.addEventListener("click", async () => {
        const file = fileInput.files[0];
        if (!file) {
          statusEl.textContent = "❌ Please select a file first.";
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get("student_id");

        if (!studentId) {
          statusEl.textContent = "❌ Missing student ID in link.";
          return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("studentId", studentId);

        uploadBtn.disabled = true;
        statusEl.textContent = "⏳ Uploading...";

        try {
          const res = await fetch(
            "https://szudlviwvrlmybgrquzv.supabase.co/functions/v1/smart-processor",
            {
              method: "POST",
              body: formData,
            }
          );

          const data = await res.json();
          if (res.ok) {
            statusEl.textContent = "✅ Upload successful!";
          } else {
            statusEl.textContent =
              "❌ Upload failed: " + (data.error || "Unknown error");
          }
        } catch (err) {
          statusEl.textContent = "❌ Network error: " + err.message;
        }

        uploadBtn.disabled = false;
      });
    </script>
  </body>
</html>
